# 製品構成デザインツール

自動車などの製品の部品構成を木構造で表現し、制約評価・価格計算・リスク評価を行うインタラクティブなデモアプリケーションです。

## 背景

自動車などの機器の構成を初期検討する際、様々なバリエーションの部品構成があり、それぞれに制約、価格、リスクが異なります。このツールは過去の事例や構成情報、トラブルメモを活用しながら、最適な製品設計を検討するための支援ツールです。

## 主な機能

### 1. 木構造による製品構成の可視化
- 製品の構成要素を階層的な木構造で表現
- 各選択ポイント（接点）で部品を選択
- リアルタイムで構成を組み立て

### 2. 制約評価（Z3 Solver WASM使用）
- **Z3 Solver**を使った高度な制約充足問題の解決
- 部品間の互換性チェック
- 技術的な制約の検証
- エラー、警告、情報の3段階で制約違反を表示
- 論理式による制約定義（AND, OR, NOT, IMPLIES等）

### 3. 価格計算
- 選択した部品の合計価格を自動計算
- 部品ごとの価格内訳を表示
- 価格情報が不足している部品の警告

### 4. リスク評価
- 過去事例に基づくリスクスコアの算出
- 成功事例、問題事例、警告の表示
- 関連する過去事例の参照

## UI構成

### 左ペイン：部品構成ツリー
- 階層的な木構造で製品構成を表示
- 各選択ポイントでドロップダウンから部品を選択
- 選択した部品の詳細情報（説明、価格）を表示

### 右ペイン上部：制約と過去事例
- **制約一覧**：すべての制約ルールを表示
  - エラー（赤）：組み合わせ不可
  - 警告（黄）：推奨されない
  - 情報（青）：推奨される組み合わせ
- **過去事例**：関連する成功事例、問題事例、警告を表示

### 右ペイン下部：評価実行と結果
- **制約評価ボタン**：現在の構成を評価
- **評価結果表示**：
  - 合計価格と内訳
  - リスクスコア（1-10段階）
  - 制約違反の一覧
  - 警告メッセージ

## 技術スタック

- **React 19** - UIフレームワーク
- **TypeScript** - 型安全な開発
- **Vite** - 高速ビルドツール
- **TailwindCSS** - ユーティリティファーストCSS
- **Z3 Solver (オプショナル)** - Microsoft製SMTソルバー（WASM版）
  - 動的インポートでロード、無くても動作
  - 算術制約（価格、リスクなど）の厳密な検証
  - JavaScriptフォールバックあり
- **カスタム論理式エンジン** - 論理制約評価システム
  - AND, OR, NOT, IMPLIES, XORの論理式
  - JavaScriptネイティブ実装
- **React Flow** - フローチャート・グラフ可視化（依存関係のみ）

## セットアップ

### 必要な環境
- Node.js 18以上
- npm または yarn

### インストール

```bash
# リポジトリをクローン
git clone <repository-url>
cd ccw-feature_explore

# 依存関係のインストール（重要：z3-solverを含む）
npm install

# 開発サーバーの起動
npm run dev

# プロダクションビルド
npm run build

# プレビュー
npm run preview
```


## サンプルデータ

自動車の部品構成を例として以下のデータを用意しています：

### 部品カテゴリ
- **エンジン**: ガソリン1.5L, ガソリン2.0L, ディーゼル2.0L, ハイブリッド
- **トランスミッション**: 5速MT, 6速AT, CVT
- **タイヤ**: 16インチ標準, 17インチスポーツ, 18インチプレミアム
- **ブレーキ**: 標準ディスク, 大径ベンチレーテッド, カーボンセラミック
- **サスペンション**: 標準, スポーツ
- **インテリア**: ファブリック, レザー, スポーツシート

### 制約例
- ハイブリッド × 5速MT：組み合わせ不可（技術的制約）
- ディーゼル × CVT：組み合わせ不可（技術的制約）
- 1.5Lエンジン × 18インチタイヤ：非推奨（性能低下）
- スポーツタイヤ × 高性能ブレーキ：推奨

### 過去事例
- 1.5L + CVT：多数の成功実績（リスクスコア: 1）
- 2.0L + スポーツタイヤ：振動問題の報告（リスクスコア: 6）
- ハイブリッド + CVT：高評価（リスクスコア: 2）

## プロジェクト構造

```
ccw-feature_explore/
├── src/
│   ├── components/          # Reactコンポーネント
│   │   ├── TreeView.tsx        # 木構造表示
│   │   ├── ConstraintsPanel.tsx # 制約・過去事例表示
│   │   └── EvaluationPanel.tsx  # 評価実行・結果表示
│   ├── types/               # TypeScript型定義
│   │   └── index.ts
│   ├── data/                # サンプルデータ
│   │   └── sampleData.ts
│   ├── utils/               # ユーティリティ関数
│   │   ├── evaluation.ts    # 評価ロジック
│   │   └── z3Evaluation.ts  # Z3風制約評価
│   ├── App.tsx              # メインアプリケーション
│   ├── main.tsx             # エントリーポイント
│   └── index.css            # グローバルスタイル
├── index.html
├── vite.config.ts
├── tsconfig.json
├── tailwind.config.js
└── package.json
```

## 使い方

1. **部品を選択**：左ペインの各選択ポイントでドロップダウンから部品を選択
2. **制約を確認**：右ペイン上部で適用される制約と過去事例を確認
3. **評価を実行**：右ペイン下部の「制約評価を実行」ボタンをクリック
4. **結果を確認**：
   - 合計価格と内訳
   - リスクスコア
   - 制約違反の有無
   - 警告メッセージ

## Z3 Solver統合制約評価システム

このアプリケーションは、Microsoft Researchの「Z3」定理証明器を統合した制約評価システムを実装しています。

### 実装について

**Z3 Solverのオプショナル統合**

本実装はZ3 Solver（WASM版）を動的インポートで使用し、以下の制約評価をサポートします：

1. **論理制約**（JavaScript実装）
   - AND, OR, NOT, IMPLIES, XORの論理式
   - 部品間の構造的な制約

2. **算術制約**（Z3 Solver使用）
   - 価格制約：`total_price <= 300000`
   - リスク制約：`expected_failure_cost < 10000`
   - Z3のSMTソルバーで充足性をチェック

**フォールバック機構**

Z3 Solverが利用できない場合（npm installしていない、ブラウザ非対応など）、JavaScriptによる評価にフォールバックします。

### Z3のセットアップ（オプショナル）

Z3 Solverを使用する場合：

```bash
# z3-solverをインストール
npm install z3-solver

# 開発サーバーを起動
npm run dev
```

Z3がインストールされていない場合でも、アプリケーションは動作します（JavaScript評価にフォールバック）。

### 論理制約の定義方法

```typescript
{
  id: 'const-1',
  name: 'ハイブリッド×マニュアル非対応',
  description: 'ハイブリッドシステムは5速マニュアルと組み合わせできません',
  componentIds: ['eng-4', 'trans-1'],
  z3Constraint: {
    expr: 'not',  // NOT (eng-4 AND trans-1)
    components: ['eng-4', 'trans-1'],
  },
  severity: 'error',
}
```

### 算術制約の定義方法（Z3使用）

```typescript
{
  id: 'arith-1',
  name: '価格上限',
  expression: 'total_price <= 300000',
  description: '合計価格は30万円以下であるべき'
}
```

サポートする式：
- `total_price <= 300000` - 合計価格の上限
- `total_price >= 150000` - 合計価格の下限
- `expected_failure_cost < 10000` - 期待故障コストの上限
- 比較演算子：`<=`, `<`, `>=`, `>`, `==`

### サポートする論理式

- `and` - 論理積：すべての部品が選択されている
- `or` - 論理和：いずれかの部品が選択されている
- `not` - 論理否定：すべての部品が同時に選択されていない（NAND）
- `implies` - 含意：A が選択されているなら B も選択されているべき
- `xor` - 排他的論理和：どちらか一方のみが選択されている

### この実装の利点

1. **柔軟**: Z3をオプショナル依存として使用、無くても動作
2. **強力**: SMTソルバーによる算術制約の厳密な検証
3. **段階的導入**: 論理制約のみ→算術制約も追加、と段階的に機能拡張可能
4. **フォールバック**: Z3エラー時も動作継続
5. **教育的**: Z3の使い方を学べる実装

## 今後の拡張可能性

- ✅ **論理制約評価**（実装済み）- AND, OR, NOT, IMPLIES, XOR
- ✅ **Z3 Solver統合**（実装済み）- 算術制約の評価
- **UI拡張**：算術制約を追加・編集できるUI
- **次に選択すべき部品のナビゲーション機能**：制約を満たす選択肢を自動提案
- **最適な構成の自動提案**：Z3の最適化機能を使った最適解の探索
- **構成の保存・読み込み機能**：複数の設計案を管理
- **複数構成の比較機能**：異なる構成案を並べて比較
- **SHACL（RDF制約）のサポート**：セマンティックWeb技術との統合
- **グラフィカルな可視化の強化**：React Flowを活用した依存関係の可視化
- **より複雑な制約**：リニアプログラミング、順序制約、カーディナリティ制約

## ライセンス

ISC
